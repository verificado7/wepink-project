<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento via Pix</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    #qrcode img {
      max-width: 300px;
      margin-top: 20px;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Pagamento via Pix</h1>
  <div>
    <label for="amount">Valor (R$):</label>
    <input type="number" id="amount" value="353.00" step="0.01" required>
  </div>
  <div>
    <label for="email">E-mail:</label>
    <input type="email" id="email" value="ana.silva@gmail.com" required>
  </div>
  <div>
    <label for="name">Nome:</label>
    <input type="text" id="name" value="Ana Silva" required>
  </div>
  <div>
    <label for="cpf">CPF (somente números):</label>
    <input type="text" id="cpf" value="12345678901" maxlength="11" required>
  </div>
  <button onclick="generatePixQRCode()">Gerar QR Code</button>
  <div id="qrcode"></div>
  <div id="error" class="error"></div>

  <script>
    const backendUrl = 'https://wepink-backend.onrender.com/create-pix';
    const saveOrderUrl = 'https://wepink-backend.onrender.com/save-order';

    async function fetchWithRetry(url, options, retries = 3, delay = 2000) {
      for (let i = 0; i < retries; i++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000);
          const response = await fetch(url, { ...options, signal: controller.signal });
          clearTimeout(timeoutId);
          if (!response.ok) throw new Error(`Erro ${response.status}: ${response.statusText}`);
          return response;
        } catch (error) {
          if (i === retries - 1) {
            if (error.name === 'AbortError') {
              throw new Error('Timeout: O servidor demorou muito para responder.');
            }
            throw error;
          }
          console.warn(`Tentativa ${i + 1} falhou. Tentando novamente em ${delay}ms...`, error);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    async function generatePixQRCode() {
      const amount = parseFloat(document.getElementById('amount').value);
      const email = document.getElementById('email').value.trim();
      const name = document.getElementById('name').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = '';

      console.log('Passo 1: Iniciando geração do QR Code...', { amount, email, name, cpf });

      try {
        if (!amount || amount <= 0) throw new Error('Valor inválido.');
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('E-mail inválido.');
        if (!name || name.length < 3) throw new Error('Nome deve ter pelo menos 3 caracteres.');
        if (!cpf || !/^\d{11}$/.test(cpf)) throw new Error('CPF deve ter 11 dígitos.');

        const response = await fetchWithRetry(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, description: 'Compra Wepink', email })
        });

        const data = await response.json();
        console.log('Passo 1: Resposta do backend:', data);

        if (!data.qr_code || !data.qr_code_base64) {
          throw new Error('QR Code não retornado pelo servidor.');
        }

        const qrCodeDiv = document.getElementById('qrcode');
        qrCodeDiv.innerHTML = `<img src="data:image/png;base64,${data.qr_code_base64}" alt="QR Code Pix">`;

        const order = {
          id: Date.now().toString(),
          amount: amount,
          description: 'Compra Wepink',
          email: email,
          name: name,
          cpf: cpf,
          status: 'Gerado',
          qrCode: data.qr_code,
          qrCodeBase64: data.qr_code_base64,
          date: new Date().toISOString()
        };

        console.log('Passo 2: Salvando pedido:', order);
        const saveResponse = await fetchWithRetry(saveOrderUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });

        const saveData = await saveResponse.json();
        console.log('Passo 2: Resposta do salvamento:', saveData);
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error.message);
        errorDiv.textContent = 'Erro: ' + error.message;
      }
    }
  </script>
</body>
</html>
