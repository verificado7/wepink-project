<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>wepink :: Pagamento</title>
  <meta name="description" content="Pagamento - Wepink">
  <meta name="copyright" content="WePink">
  <meta name="author" content="WePink">
  <meta name="country" content="BRA">
  <meta name="language" content="pt-BR">
  <link rel="icon" href="/img/we.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e7ff 100%);
      min-height: 100vh;
      transition: opacity 0.5s ease;
    }
    body.fade-out {
      opacity: 0;
    }
    header, footer, section {
      padding: 20px;
    }
    .notification-bar {
      background: linear-gradient(90deg, #ff2e82, #ff99cc);
      color: white;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .notification-bar a {
      color: white;
      text-decoration: none;
      transition: color 0.3s;
    }
    .notification-bar a:hover {
      color: #f0f0f0;
      text-decoration: underline;
    }
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: linear-gradient(90deg, #ffffff, #f9f9f9);
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 0 0 12px 12px;
    }
    .header-bar .logo-text {
      font-weight: 700;
      font-size: 1.5rem;
      color: #ff2e82;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .header-icons {
      display: flex;
      gap: 10px;
      position: relative;
    }
    .header-icons svg {
      width: 24px;
      height: 24px;
      stroke: #333;
      stroke-width: 2;
      transition: stroke 0.3s;
    }
    .header-icons svg:hover {
      stroke: #ff2e82;
    }
    .menu-icon {
      background: none;
      border: none;
      cursor: pointer;
    }
    .menu-icon svg {
      width: 24px;
      height: 24px;
      stroke: #333;
      stroke-width: 2;
      transition: stroke 0.3s;
    }
    .menu-icon svg:hover {
      stroke: #ff2e82;
    }
    .payment-section {
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
      background: linear-gradient(145deg, #ffffff, #f9f9f9);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .payment-section:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }
    .payment-section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff2e82;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .payment-section .error-message {
      color: #ff2e82;
      font-size: 0.8rem;
      margin: 5px 0;
      display: none;
      background: #fff2f4;
      padding: 4px 8px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .payment-section .error-message.visible {
      display: block;
    }
    .payment-options {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .payment-options button {
      background: linear-gradient(90deg, #ffffff, #f9f9f9);
      color: #ff2e82;
      padding: 10px 20px;
      border: 2px solid #ff2e82;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .payment-options button:hover {
      background: linear-gradient(90deg, #ff2e82, #ff99cc);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .payment-options button.active {
      background: linear-gradient(90deg, #ff2e82, #ff99cc);
      color: white;
      border: 2px solid #ff99cc;
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .payment-details {
      display: none;
      text-align: left;
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(145deg, #f9f9f9, #ffffff);
      border-radius: 12px;
      border: 1px solid #eee;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .payment-details.active {
      display: block;
      opacity: 1;
    }
    .payment-details input {
      width: 100%;
      padding: 12px 15px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
      background: #f9f9f9;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .payment-details input:focus {
      border-color: #ff2e82;
      background: #fff;
      box-shadow: 0 0 8px rgba(255,46,130,0.3);
      outline: none;
    }
    .payment-details input.invalid {
      border-color: #ff2e82;
      background: #fff2f4;
    }
    .payment-details input::placeholder {
      color: #999;
      font-weight: normal;
      font-size: 0.95rem;
    }
    .payment-details .card-details {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .payment-details .card-details div {
      flex: 1;
      min-width: 100px;
    }
    .pix-details {
      text-align: center;
    }
    .pix-details img {
      width: 150px;
      height: 150px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .pix-details p {
      font-size: 0.9rem;
      color: #666;
      margin: 5px 0;
      word-break: break-all;
    }
    .pix-details button, .payment-details button {
      background: linear-gradient(90deg, #ff2e82, #ff99cc);
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
    }
    .pix-details button:hover, .payment-details button:hover {
      background: linear-gradient(90deg, #e02974, #ff80b3);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .payment-details button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      border: 3px solid #fff;
      border-top: 3px solid #ff2e82;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .spinner.visible {
      display: block;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    button.loading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    footer {
      background: linear-gradient(90deg, #ff2e82, #ff99cc);
      color: #fff;
      padding: 40px 20px;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      margin-top: auto;
      transition: background 0.3s ease;
    }
    footer .footer-logo {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    footer .footer-logo:hover {
      transform: scale(1.05);
    }
    footer .footer-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }
    footer .footer-links a {
      color: #fff;
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 400;
      padding: 8px 12px;
      border-radius: 6px;
      transition: color 0.3s ease, background 0.3s ease, transform 0.3s ease;
      text-transform: capitalize;
    }
    footer .footer-links a:hover {
      color: #ff2e82;
      background: #fff;
      transform: translateY(-2px);
    }
    footer .footer-links a:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    footer .social-links {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }
    footer .social-links a {
      background-color: #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    footer .social-links a:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      background: #f0f0f0;
    }
    footer .social-links a:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    footer .social-links img {
      width: 24px;
      height: 24px;
      transition: filter 0.3s ease;
    }
    footer .social-links a:hover img {
      filter: brightness(0.9);
    }
    footer .payment-methods {
      text-align: center;
      margin-top: 24px;
    }
    footer .payment-methods h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    footer .payment-methods img {
      margin: 0 6px;
      height: 30px;
      border-radius: 4px;
      background: #fff;
      padding: 2px;
      transition: transform 0.3s ease, filter 0.3s ease;
    }
    footer .payment-methods img:hover {
      transform: scale(1.1);
      filter: brightness(0.9);
    }
    footer .payment-methods img.pix-icon {
      height: 40px;
    }
    footer .footer-info {
      text-align: center;
      margin-top: 24px;
    }
    footer .footer-info p {
      font-size: 0.85rem;
      margin: 6px 0;
      opacity: 0.9;
    }
    footer .footer-info a {
      color: #fff;
      text-decoration: none;
      transition: color 0.3s ease, text-decoration 0.3s ease;
    }
    footer .footer-info a:hover {
      color: #f0f0f0;
      text-decoration: underline;
    }
    footer .footer-info a:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    @media (max-width: 600px) {
      .header-bar .logo-text { font-size: 1.2rem; }
      .header-icons svg { width: 20px; height: 20px; }
      .menu-icon svg { width: 20px; height: 20px; }
      .payment-section { padding: 15px; }
      .payment-section h2 { font-size: 1.2rem; }
      .payment-options { gap: 10px; }
      .payment-options button { font-size: 0.8rem; padding: 8px 15px; }
      .payment-details { padding: 10px; }
      .payment-details input { font-size: 0.85rem; }
      .payment-details input::placeholder { font-size: 0.85rem; }
      .payment-details button { font-size: 0.9rem; padding: 10px 15px; }
      .pix-details img { width: 120px; height: 120px; }
      .pix-details p { font-size: 0.75rem; }
      footer { padding: 32px 12px; }
      footer .footer-logo { font-size: 1.3rem; margin-bottom: 20px; }
      footer .footer-links { gap: 12px; margin-bottom: 24px; }
      footer .footer-links a { font-size: 0.85rem; padding: 6px 10px; }
      footer .social-links { gap: 12px; margin-bottom: 24px; }
      footer .social-links a { width: 35px; height: 35px; }
      footer .social-links img { width: 20px; height: 20px; }
      footer .payment-methods h4 { font-size: 0.9rem; margin-bottom: 12px; }
      footer .payment-methods img { height: 28px; }
      footer .payment-methods img.pix-icon { height: 38px; }
      footer .footer-info { margin-top: 24px; }
      footer .footer-info p { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <!-- Barra de Notificação -->
  <div class="notification-bar">
    Garanta agora o seu <strong>we favorito!</strong> <a href="feminino.html">Confira</a>
  </div>

  <!-- Cabeçalho -->
  <div class="header-bar">
    <button class="menu-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
    <div class="logo-text">wepink</div>
    <div class="header-icons">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    </div>
  </div>

  <!-- Seção de Pagamento -->
  <section class="payment-section">
    <h2>Finalizar Pagamento</h2>
    <p id="error-message" class="error-message">Nenhum pedido encontrado. Volte ao carrinho para continuar sua compra.</p>
    <div class="payment-options">
      <button id="pix-button" onclick="selectPaymentMethod('pix')"><i class="fas fa-qrcode"></i> Pix</button>
      <button id="card-button" onclick="selectPaymentMethod('card')"><i class="fas fa-credit-card"></i> Cartão</button>
    </div>
    <div id="pix-details" class="payment-details pix-details">
      <p id="pix-total"></p>
      <img id="pix-qr-code" alt="QR Code Pix">
      <p id="pix-code"></p>
      <button onclick="confirmPixPayment()">Confirmar Pagamento Pix</button>
    </div>
    <div id="card-details" class="payment-details">
      <input type="text" id="card-name" placeholder="Nome no Cartão" oninput="validateCardForm()" aria-label="Nome no cartão">
      <p class="error-message" id="error-card-name"></p>
      <input type="email" id="card-email" placeholder="E-mail" oninput="validateCardForm()" aria-label="E-mail do titular do cartão">
      <p class="error-message" id="error-card-email"></p>
      <input type="text" id="card-cpf" placeholder="CPF (somente números)" maxlength="11" oninput="validateCardForm(); cleanCPFInput(this)" aria-label="CPF do titular do cartão">
      <p class="error-message" id="error-card-cpf"></p>
      <input type="text" id="card-number" placeholder="Número do Cartão" maxlength="19" oninput="validateCardForm(); formatCardNumber(this)" aria-label="Número do cartão">
      <p class="error-message" id="error-card-number"></p>
      <div class="card-details">
        <div>
          <input type="text" id="card-exp-month" placeholder="Mês (MM)" maxlength="2" oninput="validateCardForm(); cleanNumberInput(this)" aria-label="Mês de validade do cartão">
          <p class="error-message" id="error-card-exp-month"></p>
        </div>
        <div>
          <input type="text" id="card-exp-year" placeholder="Ano (AA)" maxlength="2" oninput="validateCardForm(); cleanNumberInput(this)" aria-label="Ano de validade do cartão">
          <p class="error-message" id="error-card-exp-year"></p>
        </div>
        <div>
          <input type="text" id="card-cvv" placeholder="CVV" maxlength="3" oninput="validateCardForm(); cleanNumberInput(this)" aria-label="Código CVV do cartão">
          <p class="error-message" id="error-card-cvv"></p>
        </div>
      </div>
      <button id="card-pay-button" onclick="confirmCardPayment()" disabled>Confirmar Pagamento <span class="spinner" id="card-spinner"></span></button>
    </div>
  </section>

  <!-- Rodapé -->
  <footer>
    <div class="footer-logo">wepink</div>
    <nav class="footer-links" role="navigation" aria-label="Links do rodapé">
      <a href="#">Sobre nós</a>
      <a href="#">Central de ajuda</a>
      <a href="#">Troca e devoluções</a>
      <a href="#">WhatsApp</a>
      <a href="#">Regulamento Live Wepink 19</a>
      <a href="#">Trabalhe conosco</a>
      <a href="#">Consulte sua entrega</a>
      <a href="#">Franquias</a>
    </nav>
    <div class="social-links" role="navigation" aria-label="Links sociais">
      <a href="https://www.instagram.com" target="_blank" aria-label="Instagram">
        <img src="/img/instagram.png" alt="Ícone do Instagram" onerror="this.src='https://via.placeholder.com/24?text=IG';">
      </a>
      <a href="https://www.facebook.com" target="_blank" aria-label="Facebook">
        <img src="/img/facebook.png" alt="Ícone do Facebook" onerror="this.src='https://via.placeholder.com/24?text=FB';">
      </a>
      <a href="https://www.youtube.com" target="_blank" aria-label="YouTube">
        <img src="/img/youtube.png" alt="Ícone do YouTube" onerror="this.src='https://via.placeholder.com/24?text=YT';">
      </a>
      <a href="https://www.whatsapp.com" target="_blank" aria-label="WhatsApp">
        <img src="/img/whatsapp.png" alt="Ícone do WhatsApp" onerror="this.src='https://via.placeholder.com/24?text=WA';">
      </a>
    </div>
    <div class="payment-methods">
      <h4>Formas de pagamento</h4>
      <img src="/img/visa.png" alt="Ícone da bandeira Visa" onerror="this.src='https://via.placeholder.com/30?text=Visa';">
      <img src="/img/mastercard.png" alt="Ícone da bandeira Mastercard" onerror="this.src='https://via.placeholder.com/30?text=MC';">
      <img src="/img/elo.png" alt="Ícone da bandeira Elo" onerror="this.src='https://via.placeholder.com/30?text=Elo';">
      <img src="/img/amex.png" alt="Ícone da bandeira Amex" onerror="this.src='https://via.placeholder.com/30?text=Amex';">
      <img src="/img/boleto.png" alt="Ícone do método Boleto" onerror="this.src='https://via.placeholder.com/30?text=Boleto';">
      <img src="/img/pix.png" alt="Ícone do método Pix" class="pix-icon" onerror="this.src='https://via.placeholder.com/40?text=Pix';">
    </div>
    <div class="footer-info">
      <p>Política de Privacidade | Termos de Uso</p>
      <p>Todos os direitos reservados © 2025 | SAVI COSMÉTICOS LTDA | CNPJ: 42.422.967/0001-01</p>
    </div>
  </footer>

  <script>
    let purchaseData = JSON.parse(localStorage.getItem('pendingPurchase')) || {};
    console.log('Dados de pendingPurchase ao carregar payment.html:', purchaseData);

    const ACCESS_TOKEN = 'YOUR_ACCESS_TOKEN'; // Substitua pelo seu access_token do Mercado Pago

    window.onload = function() {
      const errorMessage = document.getElementById('error-message');
      if (!purchaseData.cartItems || purchaseData.cartItems.length === 0) {
        errorMessage.classList.add('visible');
        document.querySelector('.payment-options').style.display = 'none';
        document.querySelector('#pix-details').style.display = 'none';
        document.querySelector('#card-details').style.display = 'none';
        setTimeout(() => window.location.href = 'product.html', 3000);
      } else {
        errorMessage.classList.remove('visible');
        document.querySelector('.payment-options').style.display = 'flex';
        selectPaymentMethod('pix');
      }
    };

    function selectPaymentMethod(method) {
      const pixButton = document.getElementById('pix-button');
      const cardButton = document.getElementById('card-button');
      const pixDetails = document.getElementById('pix-details');
      const cardDetails = document.getElementById('card-details');

      if (method === 'pix') {
        pixButton.classList.add('active');
        cardButton.classList.remove('active');
        pixDetails.classList.add('active');
        cardDetails.classList.remove('active');
        generatePix();
      } else {
        pixButton.classList.remove('active');
        cardButton.classList.add('active');
        pixDetails.classList.remove('active');
        cardDetails.classList.add('active');
      }
    }

    function formatCurrency(value) {
      return `R$ ${parseFloat(value || 0).toFixed(2).replace('.', ',')}`;
    }

    async function generatePix() {
      let subtotal = 0;
      purchaseData.cartItems.forEach(item => {
        subtotal += (item.priceNew || 0) * (item.quantity || 1);
      });
      const deliveryFee = purchaseData.address?.deliveryFee || 0;
      const total = subtotal + deliveryFee;

      const pixTotal = document.getElementById('pix-total');
      const pixCode = document.getElementById('pix-code');
      const qrCodeImg = document.getElementById('pix-qr-code');

      pixTotal.textContent = `Total a pagar: ${formatCurrency(total)}`;

      // Dados do pagador a partir do purchaseData
      const payer = {
        email: purchaseData.email || 'cliente@wepink.com',
        first_name: purchaseData.name ? purchaseData.name.split(' ')[0] : 'Cliente',
        last_name: purchaseData.name ? purchaseData.name.split(' ').slice(1).join(' ') : 'WePink',
        identification: {
          type: 'CPF',
          number: purchaseData.cpf || '12345678901'
        },
        address: {
          zip_code: purchaseData.address?.cep || '01001000',
          street_name: purchaseData.address?.street || 'Rua Desconhecida',
          street_number: purchaseData.address?.number || '123',
          neighborhood: purchaseData.address?.neighborhood || 'Bairro Desconhecido',
          city: purchaseData.address?.city || 'São Paulo',
          federal_unit: purchaseData.address?.state || 'SP'
        }
      };

      // Dados do pagamento
      const paymentData = {
        transaction_amount: total,
        description: purchaseData.cartItems.map(item => item.name).join(', '),
        payment_method_id: 'pix',
        payer: payer
      };

      try {
        const response = await fetch('https://api.mercadopago.com/v1/payments', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ACCESS_TOKEN}`,
            'X-Idempotency-Key': `wepink_${Date.now()}_${Math.random().toString(36).substring(2)}`
          },
          body: JSON.stringify(paymentData)
        });

        if (!response.ok) {
          throw new Error(`Erro na API do Mercado Pago: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Resposta da API do Mercado Pago:', data);

        if (data.status === 'pending' && data.point_of_interaction?.transaction_data) {
          const transactionData = data.point_of_interaction.transaction_data;
          qrCodeImg.src = `data:image/png;base64,${transactionData.qr_code_base64}`;
          pixCode.textContent = `Código Pix: ${transactionData.qr_code}`;
          qrCodeImg.dataset.pixData = JSON.stringify(data); // Armazenar os dados do pagamento para uso posterior
        } else {
          throw new Error('Dados do QR Code não encontrados na resposta da API.');
        }
      } catch (error) {
        console.error('Erro ao gerar o Pix:', error);
        pixCode.textContent = 'Erro ao gerar o Pix. Tente novamente mais tarde.';
        qrCodeImg.src = 'https://via.placeholder.com/150?text=Erro+ao+Gerar+QR+Code';
      }
    }

    function confirmPixPayment() {
      const qrCodeImg = document.getElementById('pix-qr-code');
      const pixData = qrCodeImg.dataset.pixData ? JSON.parse(qrCodeImg.dataset.pixData) : null;

      if (!pixData) {
        alert('Erro: Dados do Pix não encontrados. Tente novamente.');
        return;
      }

      const adminOrders = JSON.parse(localStorage.getItem('adminOrders')) || [];
      const order = {
        purchaseData: purchaseData,
        items: purchaseData.cartItems,
        customerDetails: {
          name: purchaseData.name,
          email: purchaseData.email,
          cpf: purchaseData.cpf
        },
        paymentMethod: 'Pix',
        pixDetails: {
          first_name: pixData.payer.first_name,
          last_name: pixData.payer.last_name,
          email: pixData.payer.email,
          identification: pixData.payer.identification,
          qrCode: pixData.point_of_interaction.transaction_data.qr_code,
          amount: pixData.transaction_amount
        },
        orderDate: new Date().toISOString(),
        status: 'Gerado',
        loginType: purchaseData.loginType || 'Unknown'
      };
      adminOrders.push(order);
      localStorage.setItem('adminOrders', JSON.stringify(adminOrders));
      localStorage.removeItem('pendingPurchase');
      console.log('Pedido salvo com Pix:', order);

      document.body.classList.add('fade-out');
      setTimeout(() => window.location.href = 'index.html', 500);
    }

    function cleanCPFInput(input) {
      input.value = input.value.replace(/\D/g, '').slice(0, 11);
    }

    function cleanNumberInput(input) {
      input.value = input.value.replace(/\D/g, '');
    }

    function formatCardNumber(input) {
      let value = input.value.replace(/\D/g, '').slice(0, 16);
      let formatted = '';
      for (let i = 0; i < value.length; i++) {
        formatted += i > 0 && i % 4 === 0 ? ' ' + value[i] : value[i];
      }
      input.value = formatted;
    }

    function validateCardForm() {
      const nameInput = document.getElementById('card-name');
      const emailInput = document.getElementById('card-email');
      const cpfInput = document.getElementById('card-cpf');
      const numberInput = document.getElementById('card-number');
      const expMonthInput = document.getElementById('card-exp-month');
      const expYearInput = document.getElementById('card-exp-year');
      const cvvInput = document.getElementById('card-cvv');
      const payButton = document.getElementById('card-pay-button');

      let isValid = true;

      const nameValue = nameInput.value.trim();
      const nameError = document.getElementById('error-card-name');
      if (!nameValue || nameValue.length < 3) {
        nameInput.classList.add('invalid');
        nameError.textContent = 'O nome deve ter pelo menos 3 caracteres.';
        nameError.classList.add('visible');
        isValid = false;
      } else {
        nameInput.classList.remove('invalid');
        nameError.classList.remove('visible');
      }

      const emailValue = emailInput.value.trim();
      const emailError = document.getElementById('error-card-email');
      if (!emailValue || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
        emailInput.classList.add('invalid');
        emailError.textContent = 'Por favor, insira um e-mail válido.';
        emailError.classList.add('visible');
        isValid = false;
      } else {
        emailInput.classList.remove('invalid');
        emailError.classList.remove('visible');
      }

      const cpfValue = cpfInput.value.replace(/\D/g, '');
      const cpfError = document.getElementById('error-card-cpf');
      if (cpfValue.length !== 11) {
        cpfInput.classList.add('invalid');
        cpfError.textContent = 'O CPF deve conter exatamente 11 dígitos.';
        cpfError.classList.add('visible');
        isValid = false;
      } else {
        cpfInput.classList.remove('invalid');
        cpfError.classList.remove('visible');
      }

      const numberValue = numberInput.value.replace(/\D/g, '');
      const numberError = document.getElementById('error-card-number');
      if (numberValue.length !== 16) {
        numberInput.classList.add('invalid');
        numberError.textContent = 'O número do cartão deve conter exatamente 16 dígitos.';
        numberError.classList.add('visible');
        isValid = false;
      } else {
        numberInput.classList.remove('invalid');
        numberError.classList.remove('visible');
      }

      const expMonthValue = expMonthInput.value.replace(/\D/g, '');
      const expMonthError = document.getElementById('error-card-exp-month');
      if (expMonthValue.length !== 2 || parseInt(expMonthValue) < 1 || parseInt(expMonthValue) > 12) {
        expMonthInput.classList.add('invalid');
        expMonthError.textContent = 'O mês deve ser um valor entre 01 e 12.';
        expMonthError.classList.add('visible');
        isValid = false;
      } else {
        expMonthInput.classList.remove('invalid');
        expMonthError.classList.remove('visible');
      }

      const expYearValue = expYearInput.value.replace(/\D/g, '');
      const expYearError = document.getElementById('error-card-exp-year');
      const currentYear = new Date().getFullYear() % 100;
      if (expYearValue.length !== 2 || parseInt(expYearValue) < currentYear) {
        expYearInput.classList.add('invalid');
        expYearError.textContent = `O ano deve ser maior ou igual a ${currentYear}.`;
        expYearError.classList.add('visible');
        isValid = false;
      } else {
        expYearInput.classList.remove('invalid');
        expYearError.classList.remove('visible');
      }

      const cvvValue = cvvInput.value.replace(/\D/g, '');
      const cvvError = document.getElementById('error-card-cvv');
      if (cvvValue.length !== 3) {
        cvvInput.classList.add('invalid');
        cvvError.textContent = 'O CVV deve conter exatamente 3 dígitos.';
        cvvError.classList.add('visible');
        isValid = false;
      } else {
        cvvInput.classList.remove('invalid');
        cvvError.classList.remove('visible');
      }

      payButton.disabled = !isValid;
    }

    function showLoadingSpinner(buttonId, spinnerId) {
      const button = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      button.classList.add('loading');
      button.disabled = true;
      spinner.classList.add('visible');
      document.body.classList.add('fade-out');
    }

    function confirmCardPayment() {
      showLoadingSpinner('card-pay-button', 'card-spinner');

      let subtotal = 0;
      purchaseData.cartItems.forEach(item => {
        subtotal += (item.priceNew || 0) * (item.quantity || 1);
      });
      const deliveryFee = purchaseData.address?.deliveryFee || 0;
      const total = subtotal + deliveryFee;

      const paymentDetails = {
        cardName: document.getElementById('card-name').value.trim(),
        email: document.getElementById('card-email').value.trim(),
        cardCPF: document.getElementById('card-cpf').value.replace(/\D/g, ''),
        cardNumber: document.getElementById('card-number').value.replace(/\D/g, ''),
        expMonth: document.getElementById('card-exp-month').value,
        expYear: document.getElementById('card-exp-year').value,
        cvv: document.getElementById('card-cvv').value,
        transactionAmount: total
      };

      const adminOrders = JSON.parse(localStorage.getItem('adminOrders')) || [];
      const order = {
        purchaseData: purchaseData,
        items: purchaseData.cartItems,
        customerDetails: {
          name: purchaseData.name,
          email: purchaseData.email,
          cpf: purchaseData.cpf
        },
        paymentMethod: 'Cartão',
        paymentDetails: paymentDetails,
        orderDate: new Date().toISOString(),
        status: 'Efetuado',
        loginType: purchaseData.loginType || 'Unknown'
      };
      adminOrders.push(order);
      localStorage.setItem('adminOrders', JSON.stringify(adminOrders));
      localStorage.removeItem('pendingPurchase');
      console.log('Pedido salvo com Cartão:', order);

      setTimeout(() => window.location.href = 'index.html', 500);
    }
  </script>
</body>
</html>
