<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>wepink :: Pagamento</title>
  <meta name="description" content="Finalize sua compra na Wepink">
  <meta name="copyright" content="WePink">
  <meta name="author" content="WePink">
  <meta name="country" content="BRA">
  <meta name="language" content="pt-BR">
  <meta name="robots" content="index, follow">
  <link rel="icon" href="img/we.png" type="image/png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: #f5f5f5; color: #333; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { font-size: 24px; color: #e91e63; text-align: center; }
    .payment-options { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .payment-btn { padding: 10px 20px; background: #e91e63; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    .payment-btn:disabled { background: #ccc; cursor: not-allowed; }
    .pix-form { display: none; margin-top: 20px; }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; }
    input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
    #pix-qr-manual, #pix-code-manual { display: none; text-align: center; margin-top: 20px; }
    #pix-qr-image { max-width: 200px; margin: 10px auto; }
    #pix-code-text { word-break: break-all; font-size: 14px; background: #f0f0f0; padding: 10px; border-radius: 5px; }
    .error-screen { display: none; color: #d32f2f; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pagamento</h1>
    <div class="payment-options">
      <button class="payment-btn" onclick="showPixForm()">Pix</button>
      <button class="payment-btn" onclick="showCardForm()">Cartão</button>
    </div>
    <div id="pix-form" class="pix-form">
      <div class="input-group">
        <label for="pix-payer-name">Nome completo</label>
        <input type="text" id="pix-payer-name" placeholder="Digite seu nome completo">
      </div>
      <div class="input-group">
        <label for="pix-payer-cpf">CPF</label>
        <input type="text" id="pix-payer-cpf" placeholder="Digite seu CPF (somente números)">
      </div>
      <div class="input-group">
        <label for="pix-email-input">E-mail</label>
        <input type="email" id="pix-email-input" placeholder="Digite seu e-mail">
      </div>
      <button id="generate-pix-button" class="payment-btn" onclick="generatePixQRCode()">Gerar Pix</button>
    </div>
    <div id="pix-qr-manual">
      <h2>Escaneie o QR Code</h2>
      <img id="pix-qr-image" alt="QR Code Pix">
    </div>
    <div id="pix-code-manual">
      <h2>Ou use o código para copiar/colar</h2>
      <p id="pix-code-text"></p>
    </div>
    <div id="error-screen" class="error-screen"></div>
  </div>

  <script>
    const backendUrl = 'https://wepink-backend.onrender.com';

    function showPixForm() {
      document.getElementById('pix-form').style.display = 'block';
      document.querySelector('.payment-options').style.display = 'none';
      document.getElementById('error-screen').style.display = 'none';
    }

    function showCardForm() {
      alert('Formulário de cartão ainda não implementado.');
    }

    function showErrorScreen(message) {
      const errorScreen = document.getElementById('error-screen');
      errorScreen.textContent = message;
      errorScreen.style.display = 'block';
    }

    async function generatePixQRCode() {
      const purchase = JSON.parse(localStorage.getItem('pendingPurchase')) || {};
      const nameInput = document.getElementById('pix-payer-name').value.trim();
      const cpfInput = document.getElementById('pix-payer-cpf').value.replace(/\D/g, '').trim();
      const emailInput = document.getElementById('pix-email-input').value.trim();
      const qrImage = document.getElementById('pix-qr-image');
      const generateButton = document.getElementById('generate-pix-button');

      let subtotal = 0;
      purchase.cartItems.forEach(item => {
        if (item.priceNew && item.quantity) {
          subtotal += item.priceNew * item.quantity;
        }
      });
      const totalAmount = subtotal + (purchase.address?.deliveryFee || 0);

      if (totalAmount <= 0) {
        showErrorScreen('Valor do pedido inválido. Verifique os itens no carrinho.');
        return;
      }

      if (!nameInput || nameInput.split(' ').length < 2) {
        showErrorScreen('Por favor, insira o nome completo (nome e sobrenome).');
        return;
      }

      if (!cpfInput || cpfInput.length !== 11) {
        showErrorScreen('Por favor, insira um CPF válido com 11 dígitos.');
        return;
      }

      if (!emailInput || !emailInput.includes('@') || !emailInput.includes('.')) {
        showErrorScreen('Por favor, insira um e-mail válido.');
        return;
      }

      const paymentData = {
        amount: totalAmount,
        payerEmail: emailInput,
        payerCpf: cpfInput,
        payerName: nameInput
      };

      try {
        generateButton.disabled = true;
        generateButton.textContent = 'Gerando...';

        const response = await fetch(`${backendUrl}/create-pix`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(paymentData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao gerar o Pix.');
        }

        const data = await response.json();

        if (!data.qrCode || !data.qrCodeBase64 || !data.transactionId) {
          throw new Error('Dados do PIX incompletos.');
        }

        document.getElementById('pix-form').style.display = 'none';
        const codeContainer = document.getElementById('pix-code-manual');
        const codeText = document.getElementById('pix-code-text');
        const qrContainer = document.getElementById('pix-qr-manual');

        codeContainer.style.display = 'block';
        qrContainer.style.display = 'block';
        codeText.textContent = data.qrCode;
        qrImage.src = `data:image/png;base64,${data.qrCodeBase64}`;

        window.pixPaymentId = data.transactionId;
        window.pixCode = data.qrCode;

        const orders = JSON.parse(localStorage.getItem('adminOrders')) || [];
        orders.push({
          purchaseData: purchase,
          paymentMethod: 'Pix',
          pixDetails: {
            email: emailInput,
            payerName: nameInput,
            payerCpf: cpfInput,
            paymentId: data.transactionId,
            qrCode: data.qrCode,
            amount: totalAmount,
            status: 'Gerado'
          },
          orderDate: new Date().toISOString()
        });
        localStorage.setItem('adminOrders', JSON.stringify(orders));
      } catch (error) {
        console.error('Erro ao gerar Pix:', error);
        showErrorScreen(`Erro ao gerar Pix: ${error.message}`);
      } finally {
        generateButton.disabled = false;
        generateButton.textContent = 'Gerar Pix';
      }
    }
  </script>
</body>
</html>
