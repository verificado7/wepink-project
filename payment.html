<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento via Pix</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    #qrcode img {
      max-width: 300px;
      margin-top: 20px;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Pagamento via Pix</h1>
  <button onclick="generatePixQRCode()">Gerar QR Code</button>
  <div id="qrcode"></div>
  <div id="error" class="error"></div>

  <script>
    const backendUrl = 'https://wepink-backend.onrender.com/create-pix';
    const saveOrderUrl = 'https://wepink-backend.onrender.com/save-order';

    async function generatePixQRCode() {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = '';

      console.log('Passo 1: Iniciando geração do QR Code...');

      try {
        console.log('Passo 1: Enviando requisição para /create-pix...');
        const response = await fetch(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: 353.00,
            description: 'Compra Wepink',
            email: 'ana.silva@gmail.com'
          })
        });
        console.log('Passo 1: Resposta recebida, status:', response.status);

        if (!response.ok) throw new Error(`Erro ${response.status}: ${response.statusText}`);

        const responseBody = await response.text();
        console.log('Passo 1: Resposta bruta do backend:', responseBody);

        const data = JSON.parse(responseBody);
        console.log('Passo 1: Resposta do backend (JSON):', data);

        if (!data.qr_code || !data.qr_code_base64) {
          throw new Error('QR Code não retornado pelo servidor.');
        }

        const qrCodeDiv = document.getElementById('qrcode');
        qrCodeDiv.innerHTML = `<img src="data:image/png;base64,${data.qr_code_base64}" alt="QR Code Pix">`;

        const order = {
          id: Date.now().toString(),
          amount: 353.00,
          description: 'Compra Wepink',
          email: 'ana.silva@gmail.com',
          name: 'Ana Silva',
          cpf: '12345678901',
          status: 'Gerado',
          qrCode: data.qr_code,
          qrCodeBase64: data.qr_code_base64,
          date: new Date().toISOString()
        };

        console.log('Passo 2: Enviando requisição para /save-order...');
        const saveResponse = await fetch(saveOrderUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
        console.log('Passo 2: Resposta recebida, status:', saveResponse.status);

        if (!saveResponse.ok) throw new Error(`Erro ${saveResponse.status}: ${saveResponse.statusText}`);

        const saveResponseBody = await saveResponse.text();
        console.log('Passo 2: Resposta bruta do backend (save-order):', saveResponseBody);

        const saveData = JSON.parse(saveResponseBody);
        console.log('Passo 2: Resposta do salvamento:', saveData);
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error.message);
        errorDiv.textContent = 'Erro: ' + error.message;
      }
    }
  </script>
</body>
</html>
